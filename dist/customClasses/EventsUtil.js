sap.ui.define(["plants/tagger/ui/customClasses/Util","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/layout/Grid","sap/ui/layout/GridData","sap/m/CustomListItem"],function(e,t,i,n,o,s){"use strict";return{openDialogAddEvent:function(){var e=this.getView();this.applyToFragment("dialogEvent",t.bind(this));function t(t){this.EventsUtil._loadSoils.call(this,t);if(!!t.getModel("new")&&t.getModel("new").getProperty("/mode")!=="new"){t.getModel("new").destroy();t.setModel(null,"new");t.setTitle(this.getView().getModel("i18n").getResourceBundle().getText("header_event"));this.byId("btnEventUpdateSave").setText("Add")}if(!t.getModel("new")){var n=this.EventsUtil._getInitialEvent.apply(this);n.mode="new";var o=new i(n);t.setModel(o,"new")}e.addDependent(t);t.open()}},eventsListFactory:function(e,t){var i=t.getPath();var a=t.getObject();var d=new s({});d.addStyleClass("sapUiTinyMarginBottom");var l=new n({defaultSpan:"XL3 L3 M6 S12"});d.addContent(l);var r=this.byId("eventHeader").clone(e);l.addContent(r);if(!!a.observation){var g=this.byId("eventObservation").clone(e);l.addContent(g)}if(!!a.pot){var v=this.byId("eventPot").clone(e);l.addContent(v)}if(!!a.soil){var h=this.byId("eventSoil").clone(e);l.addContent(h)}var p=l.getContent().length*3-1;if(12-p<3){var c="XL12 L12"}else{c="XL"+(12-p)+" L"+(12-p)}var m=c+" M6 S12";var u=this.byId("eventImageListItem").clone(e);var f=this.byId("eventImageContainer").clone(e);f.bindAggregation("items",{path:"events>"+i+"/images",template:u,templateShareable:false});f.setLayoutData(new o({span:m}));l.addContent(f);return d},onDeleteEventsTableRow:function(e){var i=e.getParameter("listItem").getBindingContext("events").getObject();var n=this.getOwnerComponent().getModel("events");var o=n.getProperty("/PlantsEventsDict/"+this._oCurrentPlant.id);var s=o.indexOf(i);if(s<0){t.show("An error happended in internal processing of deletion.");return}o.splice(s,1);n.refresh()},activateRadioButton:function(e){e.setSelected(true)},onSoilMixSelect:function(t){var i=t.getSource().getSelectedContexts()[0].sPath;this.applyToFragment("dialogEvent",t=>{var n=t.getModel("soils").getProperty(i);var o=t.getModel("new");var s=e.getClonedObject(n);o.setProperty("/soil",s)})},handleEventSegments:function(e){if(e.segments.observation!=="cancel"){if(e.observation.height===0){e.observation.height=undefined}if(e.observation.stem_max_diameter===0){e.observation.stem_max_diameter=undefined}}else{delete e.observation}if(e.segments.pot!=="cancel"){if(e.pot.diameter_width===0){e.pot.diameter_width=undefined}e.pot_event_type=e.segments.pot;if(this.byId("idPotHeight0").getSelected()){e.pot.shape_side="very flat"}else if(this.byId("idPotHeight1").getSelected()){e.pot.shape_side="flat"}else if(this.byId("idPotHeight2").getSelected()){e.pot.shape_side="high"}else if(this.byId("idPotHeight3").getSelected()){e.pot.shape_side="very high"}if(this.byId("idPotShape0").getSelected()){e.pot.shape_top="square"}else if(this.byId("idPotShape1").getSelected()){e.pot.shape_top="round"}else if(this.byId("idPotShape2").getSelected()){e.pot.shape_top="oval"}else if(this.byId("idPotShape3").getSelected()){e.pot.shape_top="hexagonal"}}else{delete e.pot}if(e.segments.soil!=="cancel"){e.soil_event_type=e.segments.soil;if(!e.soil.id){throw new Error("Choose soil.")}}else{delete e.soil}},_loadSoils:function(t){var n=e.getServiceUrl("events/soils");var o=this.getView().getModel("soils");if(!o){o=new i(n);this.getView().setModel(o,"soils")}else{o.loadData(n)}},_addEvent:function(i,n,o){var s=this._getFragment("dialogEvent");var a=s.getModel("new");var d=a.getData();d["plant_id"]=o;while(d.date.endsWith("_")||d.date.endsWith(":")){d.date=d.date.slice(0,-1);d.date=d.date.trim()}var l=n.find(function(e){return e.date===d.date});if(!!l){t.show("Duplicate event on that date.");return}var r=e.getClonedObject(d);if(r.date.length===0){t.show("Enter date.");return}try{this.EventsUtil.handleEventSegments.call(this,r)}catch(e){t.show(e);return}delete r.segments;delete r.mode;n.push(r);i.updateBindings();s.close()},_editEvent:function(i,n){var o=this._getFragment("dialogEvent");var s=o.getModel("new");var a=s.getData();if(!a.old_event){t.show("Can't determine old record. Aborting.");return}var d=a.old_event;while(a.date.endsWith("_")||a.date.endsWith(":")){a.date=a.date.slice(0,-1);a.date=a.date.trim()}if(a.date.length===0){t.show("Enter date.");return}var l=n.find(function(e){return e.date===a.date&&e!==d});if(!!l){t.show("Duplicate event on that date.");return}Object.keys(a).forEach(function(t){d[t]=e.getClonedObject(a[t])});try{this.EventsUtil.handleEventSegments.call(this,d)}catch(e){t.show(e);return}delete d.segments;delete d.mode;delete d.old_event;i.updateBindings();i.refresh(true);o.close()},addOrEditEvent:function(e){var t=this._getFragment("dialogEvent");var i=t.getModel("new");var n=i.getData();var o=n.mode;var s=this.getOwnerComponent().getModel("events");var a="/PlantsEventsDict/"+this._oCurrentPlant.id+"/";var d=s.getProperty(a);if(o==="edit"){this.EventsUtil._editEvent.apply(this,[s,d])}else{this.EventsUtil._addEvent.apply(this,[s,d,this._oCurrentPlant.id])}},onEditEvent:function(e){var t=e.getSource().getBindingContext("events").getObject();this.applyToFragment("dialogEvent",this.EventsUtil._onEditEvent.bind(this,t))},_onEditEvent:function(t,n){this.EventsUtil._loadSoils.call(this,n);n.setTitle("Edit Event ("+t.date+")");this.byId("btnEventUpdateSave").setText("Update");var o=this.EventsUtil._getInitialEvent.apply(this);o.mode="edit";o.date=t.date;o.event_notes=t.event_notes;o.old_event=t;if(t.pot&&t.pot.id){o.pot.id=t.pot.id}if(t.observation&&t.observation.id){o.observation.id=t.observation.id}if(!!t.observation){o.segments.observation="status";o.observation.diseases=t.observation.diseases;o.observation.height=t.observation.height;o.observation.observation_notes=t.observation.observation_notes;o.observation.stem_max_diameter=t.observation.stem_max_diameter}else{o.segments.observation="cancel"}if(!!t.pot){o.segments.pot=t.pot_event_type;o.pot.diameter_width=t.pot.diameter_width;o.pot.material=t.pot.material;switch(t.pot.shape_side){case"very flat":this.byId("idPotHeight0").setSelected(true);break;case"flat":this.byId("idPotHeight1").setSelected(true);break;case"high":this.byId("idPotHeight2").setSelected(true);break;case"very high":this.byId("idPotHeight3").setSelected(true);break}switch(t.pot.shape_top){case"square":this.byId("idPotShape0").setSelected(true);break;case"round":this.byId("idPotShape1").setSelected(true);break;case"oval":this.byId("idPotShape2").setSelected(true);break;case"hexagonal":this.byId("idPotShape3").setSelected(true);break}}else{o.segments.pot="cancel"}if(!!t.soil){o.segments.soil=t.soil_event_type;o.soil=e.getClonedObject(t.soil)}else{o.segments.soil="cancel"}if(n.getModel("new")){n.getModel("new").destroy()}var s=new i(o);n.setModel(s,"new");n.open()},_getInitialEvent:function(){var t={date:e.getToday(),event_notes:"",pot:{diameter_width:4,material:this.getOwnerComponent().getModel("suggestions").getData()["potMaterialCollection"][0]},observation:{height:0,stem_max_diameter:0,diseases:"",observation_notes:""},soil:{id:undefined,soil_name:"",mix:"",description:""},segments:{observation:"cancel",pot:"cancel",soil:"cancel"}};return t},openDialogEditSoil:function(e){var t=e.getSource().getBindingContext("soils").getObject();var n={dialog_title:"Edit Soil (ID "+t.id+")",btn_text:"Update",new:false,id:t.id,soil_name:t.soil_name,description:t.description,mix:t.mix};var o=new i(n);var s=this.getView();this.applyToFragment("dialogEditSoil",e=>{e.setModel(o,"editedSoil");e.bindElement({path:"/",model:"editedSoil"});s.addDependent(e);e.open()})},openDialogNewSoil:function(e){var t=this.getView();var n={dialog_title:"New Soil",btn_text:"Create",new:true,id:undefined,soil_name:"",description:"",mix:""};var o=new i(n);this.applyToFragment("dialogEditSoil",e=>{e.setModel(o,"editedSoil");e.bindElement({path:"/",model:"editedSoil"});t.addDependent(e);e.open()})},saveNewSoil:function(i){var n=this._getFragment("dialogEvent").getModel("soils");var o=n.getData().SoilsCollection;var s=o.find(function(e){return e.soil_name===i.soil_name});if(s){t.show("Soil name already exists.");return}var a={id:undefined,soil_name:i.soil_name,description:i.description,mix:i.mix};e.startBusyDialog("Saving new soil...");$.ajax({url:e.getServiceUrl("events/soils"),type:"POST",contentType:"application/json",data:JSON.stringify(a),context:this}).done(this.EventsUtil._onSavedNewSoil.bind(this)).fail(this.modelsHelper.onReceiveErrorGeneric.bind(this,"Save New Soil"))},updateExistingSoil:function(t){var i={id:t.id,soil_name:t.soil_name,description:t.description,mix:t.mix};e.startBusyDialog("Saving updated soil...");$.ajax({url:e.getServiceUrl("events/soils"),type:"PUT",contentType:"application/json",data:JSON.stringify(i),context:this}).done(this.EventsUtil._onUpdatedExistingSoil.bind(this)).fail(this.modelsHelper.onReceiveErrorGeneric.bind(this,"Save New Soil"))},updateOrCreateSoil:function(e){var i=e.getSource().getBindingContext("editedSoil").getObject();if(i.soil_name===""||i.mix===""){t.show("Enter soil mix name and mix ingredients.");return}if(i.new){if(i.id){t.show("Unexpected ID found.");return}this.EventsUtil.saveNewSoil.call(this,i)}else{this.EventsUtil.updateExistingSoil.call(this,i)}},_onUpdatedExistingSoil:function(i,n,o){if(!i.soil.id){t.show("Unexpected backend error - No Soil ID");return}var s=this.getView().getModel("soils");var a=s.getData().SoilsCollection;var d=a.find(function(e){return e.id===i.soil.id});if(!d){t.show("Updated soil not found in Model");return}d.soil_name=i.soil.soil_name;d.description=i.soil.description;d.mix=i.soil.mix;s.updateBindings();e.stopBusyDialog();this.applyToFragment("dialogEditSoil",e=>e.close())},_onSavedNewSoil:function(i,n,o){if(!i.soil.id){t.show("Unexpected backend error - No Soil ID");return}var s=this.getView().getModel("soils");var a=s.getData().SoilsCollection;var d={id:i.soil.id,soil_name:i.soil.soil_name,description:i.soil.description,mix:i.soil.mix};a.push(d);s.updateBindings();e.stopBusyDialog();this.applyToFragment("dialogEditSoil",e=>e.close())},cancelEditSoil:function(e){this.applyToFragment("dialogEditSoil",e=>e.close())}}});
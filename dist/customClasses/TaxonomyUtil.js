sap.ui.define(["sap/ui/base/Object","sap/ui/model/json/JSONModel","sap/m/MessageToast","plants/tagger/ui/customClasses/Util","plants/tagger/ui/customClasses/MessageUtil","plants/tagger/ui/model/ModelsHelper"],function(e,t,i,a,n,s){"use strict";var o;var d=e.extend("plants.tagger.ui.customClasses.TaxonomyUtil",{constructor:function(){},onOpenFindSpeciesDialog:function(){this.applyToFragment("dialogFindSpecies",e=>e.open(),e=>{var i=new t;this.getView().setModel(i,"kewSearchResults")})},onButtonFindSpecies:function(e){var t=this.byId("inputFindSpecies").getValue();if(t.length===0){i.show("Enter species first.")}var n=this.byId("cbFindSpeciesIncludeKew").getSelected();var o=this.byId("cbGenus").getSelected();a.startBusyDialog("Retrieving results from species search...");var d={species:t,includeKew:n,searchForGenus:o};$.ajax({url:a.getServiceUrl("search_external_biodiversity"),type:"POST",contentType:"application/json",data:JSON.stringify(d),context:this}).done(this.TaxonomyUtil._onReceivingSpeciesDatabase).fail(s.getInstance().onReceiveErrorGeneric.bind(this,"search_external_biodiversity (POST)"))},_onReceivingSpeciesDatabase:function(e,t,i){a.stopBusyDialog();var s=this.getView().getModel("kewSearchResults");s.setData(e);n.getInstance().addMessageFromBackend(e.message)},onFindSpeciesChoose:function(e){var t=this.byId("tableFindSpeciesResults").getSelectedItem();if(!t){i.show("Select item from results list first.");return}var n=t.getBindingContextPath();var o=this.getView().getModel("kewSearchResults").getProperty(n);var d=o.fqId;var r=this.byId("textFindSpeciesAdditionalName").getText().trim();if(r.startsWith("Error")){var l=""}else if(r===o.name.trim()){l=""}else{l=r}var c={fqId:d,hasCustomName:l.length===0?false:true,nameInclAddition:l,source:o.source,id:o.id?o.id:undefined,plant_id:this._oCurrentPlant.id};a.startBusyDialog("Retrieving additional species information and saving them to Plants database...");var g=a.getServiceUrl("download_taxon_details");$.ajax({url:g,context:this,contentType:"application/json",type:"POST",data:JSON.stringify(c)}).done(this.TaxonomyUtil._onReceivingAdditionalSpeciesInformationSaved).fail(s.getInstance().onReceiveErrorGeneric.bind(this,"download_taxon_details (POST)"))},_onReceivingAdditionalSpeciesInformationSaved:function(e,t,s){a.stopBusyDialog();i.show(e.message.message);n.getInstance().addMessageFromBackend(e.message);this.applyToFragment("dialogFindSpecies",e=>e.close());this.getView().getBindingContext("plants").getObject().botanical_name=e.botanical_name;this.getView().getBindingContext("plants").getObject().taxon_id=e.taxon_data.id;this.getView().getModel("plants").updateBindings();var o=this.getView().getModel("taxon");var d="/TaxaDict/"+e.taxon_data.id;if(o.getProperty(d)===undefined){o.setProperty(d,e.taxon_data)}var r=this.getOwnerComponent().oTaxonDataClone;if(r.TaxaDict[e.taxon_data.id]===undefined){r.TaxaDict[e.taxon_data.id]=a.getClonedObject(e.taxon_data)}this.getView().bindElement({path:"/TaxaDict/"+e.taxon_data.id,model:"taxon"})},onFindSpeciesTableSelectedOrDataUpdated:function(e){var t=this.byId("textFindSpeciesAdditionalName");var i=this.byId("inputFindSpeciesAdditionalName");var a=this.byId("tableFindSpeciesResults").getSelectedItem();if(a===undefined||a===null){t.setText("");i.setEditable(false);i.setValue("");return}var n=a.getBindingContextPath();var s=this.getView().getModel("kewSearchResults").getProperty(n);if(s.is_custom){i.setValue("");i.setEditable(false);var o=""}else if(s.species===null||s.species===undefined){i.setValue("spec.");o="spec.";i.setEditable(true)}else{if(o==="spec."){i.setValue("");o=""}else{o=i.getValue()}i.setEditable(true)}t.setText(s.name+" "+o)},onFindSpeciesAdditionalNameLiveChange:function(e){var t=this.byId("tableFindSpeciesResults").getSelectedItem();var i=t.getBindingContextPath();var a=this.getView().getModel("kewSearchResults").getProperty(i);var n=this.byId("textFindSpeciesAdditionalName");var s=this.byId("inputFindSpeciesAdditionalName").getValue();if(!t){n.setText("Error: Select item from table first.");return}n.setText(a.name+" "+s)},onDialogFindSpeciesBeforeOpen:function(e){if(this.getView().getBindingContext("taxon")===undefined||this.getView().getBindingContext("taxon").getObject()===undefined){var t=""}else{t=this.getView().getBindingContext("taxon").getObject().name}this.byId("inputFindSpecies").setValue(t);this.byId("inputFindSpeciesAdditionalName").setValue("")},onShowMap:function(e){this.applyToFragment("dialogLeafletMap",e=>e.open())},onRefetchGbifImages:function(e,t){a.startBusyDialog("Refetching Taxon Images from GBIF for GBIF ID ..."+e);var i={gbif_id:e};$.ajax({url:a.getServiceUrl("fetch_taxon_images"),type:"POST",contentType:"application/json",data:JSON.stringify(i),context:this}).done(t.TaxonomyUtil._onReceivingRefetchdeGbifImages.bind(t)).fail(s.getInstance().onReceiveErrorGeneric.bind(t,"search_external_bifetch_taxon_imagesodiversity (POST)"))},_onReceivingRefetchdeGbifImages:function(e,t,i){a.stopBusyDialog();var s=this.getView().getModel("taxon").getProperty("/TaxaDict/"+this._oCurrentPlant.taxon_id);s.occurrenceImages=e.occurrenceImages;this.getView().getModel("taxon").updateBindings();n.getInstance().addMessageFromBackend(e.message)},onCloseLeafletMap:function(e){this._getFragment("dialogLeafletMap").close()},afterCloseLeafletMap:function(e){this._getFragment("dialogLeafletMap").destroy()}});return{getInstance:function(){if(!o){o=new d(this)}return o}}});
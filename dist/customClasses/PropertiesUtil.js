sap.ui.define(["plants/tagger/ui/customClasses/Util","sap/m/MessageToast","plants/tagger/ui/model/ModelsHelper","plants/tagger/ui/customClasses/MessageUtil","sap/ui/model/json/JSONModel"],function(e,t,r,o,a){"use strict";return{onEditPropertyValueDelete:function(e){var t=this.getOwnerComponent().getModel("properties");var r=e.getSource().getBindingContext("properties").getPath();var o=e.getSource().getBindingContext("properties").getObject();if(o.type==="taxon"){var a=this.getOwnerComponent().getModel("propertiesTaxa");var p=r.substr(0,r.lastIndexOf("/"));var n=p.substr(0,p.lastIndexOf("/"));var i=t.getProperty(n).property_name_id;var s=n.substr(0,n.lastIndexOf("/"));var l=s.substr(0,s.lastIndexOf("/"));var d=t.getProperty(l).category_id;var g=e.getSource().getBindingContext("plants").getObject().taxon_id;var y="/propertiesTaxon/"+g+"/"+d+"/properties";var _=a.getProperty(y);var c=_.find(e=>e["property_name_id"]==i);var u=c.property_values.find(e=>e["type"]=="taxon");var v=c.property_values.indexOf(u);c.property_values.splice(v,1);if(c.property_values.length===0){var f=_.indexOf(c);_.splice(f,1)}}p=r.substr(0,r.lastIndexOf("/"));var m=t.getProperty(p);var x=m.indexOf(o);m.splice(x,1);this.getView().getModel("properties").refresh()},_getTemporaryAvailablePropertiesModel:function(e,t){var r="/propertiesAvailablePerCategory/"+e.category_name;var o=t.getProperty(r);var p=this.comparePropertiesLists(o,e.properties);return new a(p)},comparePropertiesLists:function(e,t){var r=[];if(e===undefined){e=[]}e.forEach(function(e){var o=e.property_name;var a=t.find(e=>e.property_name===o);var p={property_name:o,property_name_id:e.property_name_id};if(a&&a.property_values.find(e=>e.type==="plant")){p["selected_plant"]=true;p["blocked_plant"]=true}else{p["selected_plant"]=false;p["blocked_plant"]=false}if(a&&a.property_values.find(e=>e.type==="taxon")){p["selected_taxon"]=true;p["blocked_taxon"]=true}else{p["selected_taxon"]=false;p["blocked_taxon"]=false}r.push(p)});return r},onOpenDialogNewProperty:function(e){if(!this.getView().getBindingContext("plants").getObject().taxon_id){t.show("Function available after setting botanical name.");return}var r=e.getSource();var o=r.getBindingContext("properties").getPath();this.applyToFragment("dialogNewPropertyName",e=>{e.bindElement({path:o,model:"properties"});e.openBy(r)});this._btnNew=e.getSource();this._btnNew.setType("Emphasized")},onNewPropertyNameCreate:function(e){var r=this.byId("inpPropertyName").getValue();if(!r){t.show("Enter Property Name.");return}var o=e.getSource().getBindingContext("properties").getObject().category_name;var a=e.getSource().getModel("propertyNames");var p=a.getProperty("/propertiesAvailablePerCategory/"+o);var n=p.find(e=>e["property_name"]==r);if(n){t.show("Property Name already exists.");return}p.push({countPlants:0,property_name:r});var i=this.byId("chkNewPropertyNameAddToPlant").getSelected();var s=this.byId("chkNewPropertyNameAddToTaxon").getSelected();if(i||s){var l={property_name:r,property_values:[]};e.getSource().getBindingContext("properties").getObject().properties.push(l)}if(i){l.property_values.push({type:"plant",property_value:""})}if(s){var d={type:"taxon",property_value:""};l.property_values.push(d);var g={property_name:r,property_name_id:undefined};var y=e.getSource().getBindingContext("properties").getObject().category_id;var _=e.getSource().getBindingContext("plants").getObject().taxon_id;this.PropertiesUtil._insertPropertyIntoPropertyTaxaModel(d,y,_,g,this.getOwnerComponent())}this.getView().getModel("properties").refresh();this._getFragment("dialogNewPropertyName").close();this._btnNew.setType("Transparent")},onCloseNewPropertyNameDialog:function(e){this._btnNew.setType("Transparent")},onOpenDialogAddProperty:function(e){if(!this.getView().getBindingContext("plants").getObject().taxon_id){t.show("Function available after setting botanical name.");return}var r=e.getSource();var o=r.getBindingContext("properties").getObject();var a=e.getSource().getModel("propertyNames");var p=r.getBindingContext("properties").getPath();if(this._getFragment("dialogAddProperties")){this._getFragment("dialogAddProperties").destroy()}this.applyToFragment("dialogAddProperties",e=>{var t=this.PropertiesUtil._getTemporaryAvailablePropertiesModel(o,a);e.setModel(t,"propertiesCompare");e.bindElement({path:p,model:"properties"});e.openBy(r)});e.getSource().setType("Emphasized");this._btnAdd=e.getSource()},onCloseAddPropertiesDialog:function(e){e.getParameter("openBy").setType("Transparent");e.getSource().destroy()},onAddProperty:function(e){var t=e.getSource().getModel("propertiesCompare").getData();var r=e.getSource().getBindingContext("properties").getObject().properties;var o=e.getSource().getBindingContext("properties").getObject().category_id;var a=e.getSource().getBindingContext("plants").getObject().taxon_id;for(var p=0;p<t.length;p++){var n=t[p];if(n.selected_plant&&!n.blocked_plant||n.selected_taxon&&!n.blocked_taxon){var i=r.find(e=>e.property_name_id==n.property_name_id);if(i){if(n.selected_plant&&!n.blocked_plant){i.property_values.push({type:"plant",property_value:""})}if(n.selected_taxon&&!n.blocked_taxon){var s={type:"taxon",property_value:""};i.property_values.push(s);this.PropertiesUtil._insertPropertyIntoPropertyTaxaModel(s,o,a,n,this.getOwnerComponent())}}else{var l=[];if(n.selected_plant&&!n.blocked_plant){l.push({type:"plant",property_value:""})}if(n.selected_taxon&&!n.blocked_taxon){var d={type:"taxon",property_value:""};l.push(d);this.PropertiesUtil._insertPropertyIntoPropertyTaxaModel(d,o,a,n,this.getOwnerComponent())}e.getSource().getBindingContext("properties").getObject().properties.push({property_name:n.property_name,property_name_id:n.property_name_id,property_values:l})}}}this.getView().getModel("properties").refresh();this._btnAdd.setType("Transparent");this._getFragment("dialogAddProperties").close();this._getFragment("dialogAddProperties").destroy()},_insertPropertyIntoPropertyTaxaModel:function(e,t,r,o,a){var p=a.getModel("propertiesTaxa");var n=p.getData().propertiesTaxon[r][t].properties;if(o.property_name_id){var i=n.find(e=>e.property_name_id==o.property_name_id)}else{i=n.find(e=>e.property_name==o.property_name)}if(!i){n.push({property_name:o.property_name,property_name_id:o.property_name_id,property_values:[e]})}else{i.property_values.push(e)}},_taxon_properties_already_loaded:function(e,t){if(e.getModel("propertiesTaxa").getProperty("/propertiesTaxon/"+t))return true;else return false},loadPropertiesForCurrentPlant:function(t,o){var a=encodeURIComponent(t.id);var p="plant_properties/"+a;if(t.taxon_id&&!this._taxon_properties_already_loaded(o,t.taxon_id))var n={taxon_id:t.taxon_id};else n={};$.ajax({url:e.getServiceUrl(p),data:n,context:this,async:true}).done(this._onReceivingPropertiesForPlant.bind(this,t,o)).fail(r.getInstance().onReceiveErrorGeneric.bind(this,"Property (GET)"))},_onReceivingPropertiesForPlant:function(t,r,a,p,n){var i=r.getModel("properties");i.setProperty("/propertiesPlants/"+t.id+"/",a.propertyCollections);if(!r.oPropertiesDataClone){r.oPropertiesDataClone={}}r.oPropertiesDataClone[t.id]=e.getClonedObject(a.propertyCollections);if(Object.keys(a.propertyCollectionsTaxon.categories).length>0){r.getModel("propertiesTaxa").setProperty("/propertiesTaxon/"+t.taxon_id+"/",a.propertyCollectionsTaxon.categories);if(!r.oPropertiesTaxonDataClone){r.oPropertiesTaxonDataClone={}}r.oPropertiesTaxonDataClone[t.taxon_id]=e.getClonedObject(a.propertyCollectionsTaxon.categories)}this.appendTaxonPropertiesToPlantProperties(r,t);o.getInstance().addMessageFromBackend(a.message);i.refresh(true)},appendTaxonPropertiesToPlantProperties:function(e,t){if(!t.taxon_id){return}var r=e.getModel("propertiesTaxa");var o=e.getModel("properties");var a=r.getProperty("/propertiesTaxon/"+t.taxon_id+"/");var p=o.getProperty("/propertiesPlants/"+t.id+"/categories/");for(var n=0;n<Object.keys(a).length;n++){var i=a[Object.keys(a)[n]];var s=i.category_id;var l=p.find(e=>e.category_id==s);for(var d=0;d<i.properties.length;d++){var g=i.properties[d];var y=l.properties.find(e=>e.property_name_id==g.property_name_id);if(y){y.property_values.push(...g.property_values)}else{l.properties.push(g)}}}},onCloseDialogEditPropertyValue:function(e){this._getFragment("dialogEditPropertyValue").close()},onEditPropertyValueTag:function(e){var t=e.getSource();var r=t.getBindingContext("properties").getPath();var o=this._getFragment("dialogEvent").getModel("soils");this.applyToFragment("dialogEditPropertyValue",e=>{e.setModel(o,"soils");e.bindElement({path:r,model:"properties"});e.openBy(t)})}}});
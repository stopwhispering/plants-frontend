sap.ui.define(["plants/tagger/ui/customClasses/BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","plants/tagger/ui/model/formatter","sap/m/MessageToast","plants/tagger/ui/customClasses/Util","plants/tagger/ui/customClasses/Navigation","sap/ui/core/Fragment"],function(e,t,a,n,i,s,o,r,l,d,g){"use strict";return e.extend("plants.tagger.ui.controller.Master",{formatter:o,Util:l,onInit:function(){this._oRouter=this.getOwnerComponent().getRouter();this._bDescendingSort=false},onAfterRendering:function(){var e=this.byId("plantsTable");e.attachUpdateFinished(this.updateTableHeaderPlantsCount.bind(this))},onListItemPress:function(e){var t=e.getSource().getBindingContext("plants").getObject().id;d.navToPlantDetails.call(this,t)},onSearch:function(e){var t=e.getParameter("query");var s=this.getView().byId("plantsTable").getBinding("items").aApplicationFilters;var o=[];for(var r=0;r<s.length;r++){if(!["plant_name","botanical_name",undefined].includes(s[r]["sPath"])){o.push(s[r])}}var l=[new a("plant_name",n.Contains,t),new a("botanical_name",n.Contains,t)];var d=new a({filters:l,and:false});o.push(d);this.getView().byId("plantsTable").getBinding("items").filter(o,i.Application);this.updateTableHeaderPlantsCount()},_getDistinctTagsFromPlants:function(e){var t=[];for(var a=0;a<e.length;a++){var n=e[a].tags;if(!!n){var i=n.map(function(e){return e.text});t=t.concat(i)}}return Array.from(new Set(t))},onShowFilterDialog:function(e){var a=this.getOwnerComponent().getModel("filterValues");var n=this.byId("plantsTable").getBinding("items");var i=n.getDistinctValues("current_soil/soil_name");a.setProperty("/soilNames",i);var s=n.getDistinctValues("propagation_type");a.setProperty("/propagationTypes",s);var o=n.getDistinctValues("nursery_source");a.setProperty("/nurseriesSources",o);var r=this.getOwnerComponent().getModel("plants").getData().PlantsCollection;var d=this._getDistinctTagsFromPlants(r);a.setProperty("/tags",d);var g=l.getServiceUrl("selection_data");if(!this.oModelTaxonTree){this.oModelTaxonTree=new t(g)}else{}this.applyToFragment("settingsDialogFilter",e=>{e.setModel(this.oModelTaxonTree,"selection");e.open()})},_addSelectedFlag:function(e,t){e.forEach(function(e){e.selected=t;if(e.nodes){this._addSelectedFlag(e.nodes,t)}},this)},onSelectionChangeTaxonTree:function(e){var t=e.getParameter("listItems");t.forEach(function(e){var t=e.getBindingContext("selection").getObject();var a=e.getSelected();if(t.nodes){this._addSelectedFlag(t.nodes,a)}},this);this.oModelTaxonTree.refresh()},_getSelectedItems:function(e,t){var a=[];var n=[];e.forEach(function(e){if(e.level===t&&e.selected){a.push(e);n=n.concat(e.plant_ids)}else if(e.nodes&&e.nodes.length>0){var i=this._getSelectedItems(e.nodes,t);if(i[0].length>0){a=a.concat(i[0])}if(i[1].length>0){n=n.concat(i[1])}}},this);return[a,n]},onConfirmFilters:function(e){var t=this.byId("plantsTable"),i=e.getParameters(),s=t.getBinding("items"),o=[];var r=s.aApplicationFilters;for(var l=0;l<r.length;l++){if(["plant_name","botanical_name"].includes(r[l]["sPath"])){o.push(r[l])}}var d=[];i.filterItems.forEach(function(e){var t=e.getKey().split("___"),n=t[0],i=t[1],s=t[2],r=t[3];switch(n){case"tags/text":d.push(s);break;default:var l=new a(n,i,s,r);o.push(l);if(s==""){l=new a(n,i,undefined,r);o.push(l)}break}});if(d.length>0){var g=new a({path:"tags",value1:d,comparator:function(e,t){var a=e.some(function(e){return t.includes(e.text)});return a?0:-1},operator:n.EQ});o.push(g)}var p=2;if(this.byId("taxonTree").getSelectedItems().length>0){var u=this.oModelTaxonTree.getProperty("/Selection/TaxonTree");var c=this._getSelectedItems(u,p);var h=c[1];var f=h.map(e=>new a("id",n.EQ,e));var m=new a({filters:f,and:false});o.push(m)}this.byId("tableFilterBar").setVisible(o.length>0);this.byId("tableFilterLabel").setText(i.filterString);var v=this._getHiddenPlantsFilter();if(v){o.push(v)}s.filter(o);this.updateTableHeaderPlantsCount();var y=this.byId("sbtnPreviewImage").getSelectedKey()||"favourite_image";this.getOwnerComponent().getModel("status").setProperty("/preview_image",y)},_getHiddenPlantsFilter:function(){var e=this.byId("sbtnHiddenPlants").getSelectedKey();switch(e){case"both":return undefined;case"only_hidden":return new a("active",n.EQ,false);default:return new a("active",n.EQ,true)}},onAdd:function(e){this.applyToFragment("dialogNewPlant",e=>e.open())},onAddSaveButton:function(e){var t=this.byId("inputCreateNewPlantName").getValue();if(t===""){r.show("Empty not allowed.");return}if(t.includes("/")){r.show("Forward slash not allowed.");return}if(this.isPlantNameInPlantsModel(t)){r.show("Plant Name already exists.");return}this.saveNewPlant({plant_name:t,active:true,descendant_plants_all:[],sibling_plants:[],same_taxon_plants:[],tags:[]});this.applyToFragment("dialogNewPlant",e=>e.close())},onShowSortDialog:function(e){this.applyToFragment("dialogSort",e=>e.open())},handleSortDialogConfirm:function(e){var t=this.byId("plantsTable");var a=e.getParameters();var n=t.getBinding("items");var i;var o;var r=[];i=a.sortItem.getKey();o=a.sortDescending;r.push(new s(i,o));n.sort(r)},onResetFilters:function(e){var t=l.getServiceUrl("selection_data");this.oModelTaxonTree.loadData(t)},onHoverImage:function(e,t){var a=e.getBindingContext("plants");var n=this.getView();if(!this.byId("popoverPopupImage")){g.load({name:"plants.tagger.ui.view.fragments.master.MasterImagePopover",id:n.getId(),controller:this}).then(function(t){n.addDependent(t);t.setBindingContext(a,"plants");t.openBy(e)})}else{this.byId("popoverPopupImage").setBindingContext(a,"plants");this.byId("popoverPopupImage").openBy(e)}},onClickImagePopupImage:function(e){this.applyToFragment("popoverPopupImage",e=>{if(e.isOpen){e.close()}})},onHoverAwayFromImage:function(e,t){this.applyToFragment("popoverPopupImage",e=>{if(e.isOpen){e.close()}})}})},true);
sap.ui.define(["plants/tagger/ui/customClasses/BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","plants/tagger/ui/model/formatter","sap/m/MessageToast","plants/tagger/ui/customClasses/Util","plants/tagger/ui/customClasses/Navigation"],function(e,t,n,a,i,s,r,o,l,d){"use strict";return e.extend("plants.tagger.ui.controller.Master",{formatter:r,Util:l,onInit:function(){this._oRouter=this.getOwnerComponent().getRouter();this._bDescendingSort=false},onAfterRendering:function(){var e=this.byId("plantsTable");e.attachUpdateFinished(this.updateTableHeaderPlantsCount.bind(this))},onListItemPress:function(e){var t=e.getSource().getBindingContext("plants").getObject().id;d.navToPlantDetails.call(this,t)},onSearch:function(e){var t=e.getParameter("query");var s=this.getView().byId("plantsTable").getBinding("items").aApplicationFilters;var r=[];for(var o=0;o<s.length;o++){if(!["plant_name","botanical_name",undefined].includes(s[o]["sPath"])){r.push(s[o])}}var l=[new n("plant_name",a.Contains,t),new n("botanical_name",a.Contains,t)];var d=new n({filters:l,and:false});r.push(d);this.getView().byId("plantsTable").getBinding("items").filter(r,i.Application);this.updateTableHeaderPlantsCount()},_getDistinctTagsFromPlants:function(e){var t=[];for(var n=0;n<e.length;n++){var a=e[n].tags;if(!!a){var i=a.map(function(e){return e.text});t=t.concat(i)}}return Array.from(new Set(t))},onShowFilterDialog:function(e){var n=this.getOwnerComponent().getModel("filterValues");var a=this.byId("plantsTable").getBinding("items");var i=a.getDistinctValues("current_soil/soil_name");n.setProperty("/soilNames",i);var s=a.getDistinctValues("propagation_type");n.setProperty("/propagationTypes",s);var r=a.getDistinctValues("nursery_source");n.setProperty("/nurseriesSources",r);var o=this.getOwnerComponent().getModel("plants").getData().PlantsCollection;var d=this._getDistinctTagsFromPlants(o);n.setProperty("/tags",d);var g=l.getServiceUrl("selection_data");if(!this.oModelTaxonTree){this.oModelTaxonTree=new t(g)}else{}this.applyToFragment("settingsDialogFilter",e=>{e.setModel(this.oModelTaxonTree,"selection");e.open()})},_addSelectedFlag:function(e,t){e.forEach(function(e){e.selected=t;if(e.nodes){this._addSelectedFlag(e.nodes,t)}},this)},onSelectionChangeTaxonTree:function(e){var t=e.getParameter("listItems");t.forEach(function(e){var t=e.getBindingContext("selection").getObject();var n=e.getSelected();if(t.nodes){this._addSelectedFlag(t.nodes,n)}},this);this.oModelTaxonTree.refresh()},_getSelectedItems:function(e,t){var n=[];var a=[];e.forEach(function(e){if(e.level===t&&e.selected){n.push(e);a=a.concat(e.plant_ids)}else if(e.nodes&&e.nodes.length>0){var i=this._getSelectedItems(e.nodes,t);if(i[0].length>0){n=n.concat(i[0])}if(i[1].length>0){a=a.concat(i[1])}}},this);return[n,a]},onConfirmFilters:function(e){var t=this.byId("plantsTable"),i=e.getParameters(),s=t.getBinding("items"),r=[];var o=s.aApplicationFilters;for(var l=0;l<o.length;l++){if(["plant_name","botanical_name"].includes(o[l]["sPath"])){r.push(o[l])}}var d=[];i.filterItems.forEach(function(e){var t=e.getKey().split("___"),a=t[0],i=t[1],s=t[2],o=t[3];switch(a){case"tags/text":d.push(s);break;default:var l=new n(a,i,s,o);r.push(l);if(s==""){l=new n(a,i,undefined,o);r.push(l)}break}});if(d.length>0){var g=new n({path:"tags",value1:d,comparator:function(e,t){var n=e.some(function(e){return t.includes(e.text)});return n?0:-1},operator:a.EQ});r.push(g)}var p=2;if(this.byId("taxonTree").getSelectedItems().length>0){var u=this.oModelTaxonTree.getProperty("/Selection/TaxonTree");var c=this._getSelectedItems(u,p);var h=c[1];var f=h.map(e=>new n("id",a.EQ,e));var m=new n({filters:f,and:false});r.push(m)}this.byId("tableFilterBar").setVisible(r.length>0);this.byId("tableFilterLabel").setText(i.filterString);var v=this._getHiddenPlantsFilter();if(v){r.push(v)}s.filter(r);this.updateTableHeaderPlantsCount();var y=this.byId("sbtnPreviewImage").getSelectedKey()||"favourite_image";this.getOwnerComponent().getModel("status").setProperty("/preview_image",y)},_getHiddenPlantsFilter:function(){var e=this.byId("sbtnHiddenPlants").getSelectedKey();switch(e){case"both":return undefined;case"only_hidden":return new n("active",a.EQ,false);default:return new n("active",a.EQ,true)}},onAdd:function(e){this.applyToFragment("dialogNewPlant",e=>e.open())},onAddSaveButton:function(e){var t=this.byId("inputCreateNewPlantName").getValue();if(t===""){o.show("Empty not allowed.");return}if(t.includes("/")){o.show("Forward slash not allowed.");return}if(this.isPlantNameInPlantsModel(t)){o.show("Plant Name already exists.");return}this.saveNewPlant({plant_name:t,active:true,descendant_plants_all:[],sibling_plants:[],same_taxon_plants:[],tags:[]});this.applyToFragment("dialogNewPlant",e=>e.close())},onShowSortDialog:function(e){this.applyToFragment("dialogSort",e=>e.open())},handleSortDialogConfirm:function(e){var t=this.byId("plantsTable");var n=e.getParameters();var a=t.getBinding("items");var i;var r;var o=[];i=n.sortItem.getKey();r=n.sortDescending;o.push(new s(i,r));a.sort(o)},onResetFilters:function(e){var t=l.getServiceUrl("selection_data");this.oModelTaxonTree.loadData(t)},onHoverImage:function(e,t){this.applyToFragment("popoverPopupImage",n.bind(this));function n(t){var n=e.getBindingContext("plants");t.setBindingContext(n,"plants");t.openBy(e)}},onClickImagePopupImage:function(e){this.applyToFragment("popoverPopupImage",e=>{if(e.isOpen){e.close()}})},onHoverAwayFromImage:function(e,t){this.applyToFragment("popoverPopupImage",e=>{if(e.isOpen){e.close()}})}})},true);
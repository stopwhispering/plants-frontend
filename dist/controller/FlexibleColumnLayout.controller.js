sap.ui.define(["plants/tagger/ui/customClasses/BaseController","plants/tagger/ui/model/ModelsHelper","plants/tagger/ui/customClasses/MessageUtil","plants/tagger/ui/model/formatter","sap/m/MessageToast","sap/m/MessageBox","plants/tagger/ui/customClasses/Util","sap/m/Token","sap/ui/model/Filter","sap/ui/model/FilterOperator","plants/tagger/ui/customClasses/Navigation","sap/ui/core/Fragment"],function(e,t,a,n,s,o,i,r,l,g,u,d){"use strict";return e.extend("plants.tagger.ui.controller.FlexibleColumnLayout",{formatter:n,onInit:function(){this._oRouter=this.getOwnerComponent().getRouter();this._oRouter.attachBeforeRouteMatched(this._onBeforeRouteMatched,this);this._oRouter.attachRouteMatched(this._onRouteMatched,this);this._oSearchField=this.byId("searchField");this._currentPlantId=null},_onBeforeRouteMatched:function(e){var t=this.getOwnerComponent().getModel();var a=e.getParameters().arguments.layout;if(!a){var n=this.getOwnerComponent().getHelper().getNextUIState(0);a=n.layout}if(a){t.setProperty("/layout",a)}},_onRouteMatched:function(e){var t=e.getParameter("name"),a=e.getParameter("arguments");this._updateUIElements();this.currentRouteName=t;this._currentPlantId=a.plant_id},onStateChanged:function(e){var t=e.getParameter("isNavigationArrow"),a=e.getParameter("layout");this._updateUIElements();if(t){this._oRouter.navTo(this.currentRouteName,{layout:a,plant_id:this._currentPlantId},true)}},_updateUIElements:function(){var e=this.getOwnerComponent().getModel();var t=this.getOwnerComponent().getHelper().getCurrentUIState();if(e){e.setData(t)}},onExit:function(){this._oRouter.detachRouteMatched(this._onRouteMatched,this);this._oRouter.detachBeforeRouteMatched(this._onBeforeRouteMatched,this)},onShellBarMenuButtonPressed:function(e){var t=e.getSource();var a=this.getView();if(!this.byId("menuShellBarMenu")){d.load({name:"plants.tagger.ui.view.fragments.ShellBarMenu",controller:this,id:a.getId()}).then(function(e){a.addDependent(e);e.openBy(t)})}else{this.byId("menuShellBarMenu").openBy(t)}},generateMissingThumbnails:function(){$.ajax({url:i.getServiceUrl("generate_missing_thumbnails"),type:"POST",contentType:"application/json",context:this}).done(this.onReceiveSuccessGeneric).fail(t.getInstance(undefined).onReceiveErrorGeneric.bind(this,"Generate Missing Thumbnails (POST)"))},onPressButtonSave:function(){this.savePlantsAndImages()},onPressButtonRefreshData:function(){var e=this.getModifiedPlants();var t=this.getModifiedImages();var a=this.getModifiedTaxa();if(e.length!==0||t.length!==0||a.length!==0){var n=!!this.getView().$().closest(".sapUiSizeCompact").length;o.confirm("Revert all changes?",{onClose:this.onCloseRefreshConfirmationMessageBox.bind(this),styleClass:n?"sapUiSizeCompact":""})}else{this.onCloseRefreshConfirmationMessageBox(o.Action.OK)}},onCloseRefreshConfirmationMessageBox:function(e){if(e===o.Action.OK){i.startBusyDialog("Loading...","Loading plants, taxa, and images");var a=t.getInstance();a.reloadPlantsFromBackend();a.resetImagesRegistry();a.reloadTaxaFromBackend()}},onOpenFragmentUploadPhotos:function(e){this.applyToFragment("dialogUploadPhotos",e=>e.open(),e=>{var t=this.byId("multiInputUploadImageKeywords");t.addValidator(function(e){var t=e.text;return new r({key:t,text:t})})})},uploadPhotosToServer:function(e){var t=this.byId("idPhotoUpload");if(!t.getValue()){s.show("Choose a file first");return}i.startBusyDialog("Uploading...","Image File(s)");var a=i.getServiceUrl("images/");t.setUploadUrl(a);var n=this.byId("multiInputUploadImagePlants").getTokens();var o=[];if(n.length>0){for(var r=0;r<n.length;r++){o.push(n[r].getProperty("key"))}}else{}var l=this.byId("multiInputUploadImageKeywords").getTokens();var g=[];if(l.length>0){for(r=0;r<l.length;r++){g.push(l[r].getProperty("key"))}}else{}var u={plants:o,keywords:g};t.setAdditionalData(JSON.stringify(u));t.upload()},handleUploadComplete:function(e){var n=e.getParameter("responseRaw");if(!n){var o="Upload complete, but can't determine status. No response received.";a.getInstance().addMessage("Warning",o,undefined,undefined);i.stopBusyDialog();return}var r=JSON.parse(n);if(!r){o="Upload complete, but can't determine status. Can't parse Response.";a.getInstance().addMessage("Warning",o,undefined,undefined);i.stopBusyDialog();return}a.getInstance().addMessageFromBackend(r.message);if(r.images.length>0){t.getInstance().addToImagesRegistry(r.images);this.resetImagesCurrentPlant(this.currentPlantId);this.getOwnerComponent().getModel("images").updateBindings();this.getOwnerComponent().resetUntaggedPhotos();this.getOwnerComponent().getModel("untaggedImages").updateBindings()}i.stopBusyDialog();s.show(r.message.message);this.applyToFragment("dialogUploadPhotos",e=>e.close())},onIconPressAssignDetailsPlant:function(e){var t=this.getPlantById(this._currentPlantId);if(!t){return}var a=this.byId("multiInputUploadImagePlants");if(!a.getTokens().find(e=>e.getProperty("key")==t.plant_name)){var n=new r({key:t.id,text:t.plant_name});a.addToken(n)}},onShowUntagged:function(e){var t=this.getOwnerComponent().getHelper().getNextUIState(2);this._oRouter.navTo("untagged",{layout:t.layout,plant_id:this._currentPlantId})},onShellBarSearch:function(e){var t=e.getParameter("suggestionItem").getBindingContext("plants").getObject().id;u.navToPlantDetails.call(this,t)},onShellBarSuggest:function(e){var t=e.getParameter("suggestValue"),a=[];var n=new l("active",g.EQ,true);if(t){a=[new l([new l("plant_name",function(e){return(e||"").toUpperCase().indexOf(t.toUpperCase())>-1}),new l("botanical_name",function(e){return(e||"").toUpperCase().indexOf(t.toUpperCase())>-1}),new l("id",g.EQ,t)])];var s=new l({filters:a,and:false});n=new l({filters:[n,s],and:true})}this._oSearchField.getBinding("suggestionItems").filter(n);this._oSearchField.suggest()},onShellBarNotificationsPressed:function(e){var t=e.getSource();this.applyToFragment("MessagePopover",e=>{e.isOpen()?e.close():e.openBy(t)})},onClearMessages:function(e){a.getInstance().removeAllMessages()},onHomeIconPressed:function(e){var t=this.getOwnerComponent().getHelper();var a=t.getDefaultLayouts().defaultLayoutType;this._oRouter.navTo("master",{layout:a})}})},true);